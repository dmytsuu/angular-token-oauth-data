!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/router"),require("@angular/common"),require("rxjs"),require("@angular/core"),require("@angular/common/http"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("angular-token",["exports","@angular/router","@angular/common","rxjs","@angular/core","@angular/common/http","rxjs/operators"],e):e(t["angular-token"]={},t.ng.router,t.ng.common,t.rxjs,t.ng.core,t.ng.common.http,t.rxjs.operators)}(this,function(t,e,s,y,o,n,a){"use strict";var r=new o.InjectionToken("ANGULAR_TOKEN_OPTIONS"),i=function(){function t(t,e,o,n,r){this.http=t,this.platformId=o,this.activatedRoute=n,this.router=r,this.userType=new y.BehaviorSubject(null),this.authData=new y.BehaviorSubject(null),this.userData=new y.BehaviorSubject(null),this.localStorage={},this.global="undefined"!=typeof window?window:{},s.isPlatformServer(this.platformId)?(this.global={open:function(){return null},location:{href:"/",origin:"/"}},this.localStorage.setItem=function(){return null},this.localStorage.getItem=function(){return null},this.localStorage.removeItem=function(){return null}):this.localStorage=localStorage;var i={apiPath:null,apiBase:null,signInPath:"auth/sign_in",signInRedirect:null,signInStoredUrlStorageKey:null,signOutPath:"auth/sign_out",validateTokenPath:"auth/validate_token",signOutFailedValidate:!1,registerAccountPath:"auth",deleteAccountPath:"auth",registerAccountCallback:this.global.location.href,updatePasswordPath:"auth",resetPasswordPath:"auth/password",resetPasswordCallback:this.global.location.href,userTypes:null,loginField:"email",oAuthBase:this.global.location.origin,oAuthPaths:{github:"auth/github"},oAuthCallbackPath:"oauth_callback",oAuthWindowType:"newWindow",oAuthWindowOptions:null,oAuthBrowserCallbacks:{github:"auth/github/callback"}},a=Object.assign(i,e);this.options=a,null===this.options.apiBase&&console.warn("[angular-token] You have not configured 'apiBase', which may result in security issues. Please refer to the documentation at https://github.com/neroniaky/angular-token/wiki"),this.tryLoadAuthData()}return Object.defineProperty(t.prototype,"currentUserType",{get:function(){return null!=this.userType.value?this.userType.value.name:undefined},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentUserData",{get:function(){return this.userData.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentAuthData",{get:function(){return this.authData.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"apiBase",{get:function(){return console.warn("[angular-token] The attribute .apiBase will be removed in the next major release, please use.tokenOptions.apiBase instead"),this.options.apiBase},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tokenOptions",{get:function(){return this.options},set:function(t){this.options=Object.assign(this.options,t)},enumerable:!0,configurable:!0}),t.prototype.userSignedIn=function(){return null!=this.authData.value},t.prototype.canActivate=function(t,e){return!!this.userSignedIn()||(this.options.signInStoredUrlStorageKey&&this.localStorage.setItem(this.options.signInStoredUrlStorageKey,e.url),this.router&&this.options.signInRedirect&&this.router.navigate([this.options.signInRedirect]),!1)},t.prototype.registerAccount=function(t,e){null==(t=Object.assign({},t)).userType?this.userType.next(null):(this.userType.next(this.getUserTypeByName(t.userType)),delete t.userType),null==t.password_confirmation&&null!=t.passwordConfirmation&&(t.password_confirmation=t.passwordConfirmation,delete t.passwordConfirmation),e!==undefined&&(t.additionalData=e);var o=t.login;return delete t.login,t[this.options.loginField]=o,t.confirm_success_url=this.options.registerAccountCallback,this.http.post(this.getServerPath()+this.options.registerAccountPath,t)},t.prototype.deleteAccount=function(){return this.http["delete"](this.getServerPath()+this.options.deleteAccountPath)},t.prototype.signIn=function(t,e){var o,n=this;this.userType.next(null==t.userType?null:this.getUserTypeByName(t.userType));var r=((o={})[this.options.loginField]=t.login,o.password=t.password,o);e!==undefined&&(r.additionalData=e);var i=this.http.post(this.getServerPath()+this.options.signInPath,r).pipe(a.share());return i.subscribe(function(t){return n.userData.next(t.data)}),i},t.prototype.signInOAuth=function(t,e,o,n){var r=this,i=this.getOAuthPath(t),a=this.global.location.origin+"/"+this.options.oAuthCallbackPath,s=this.options.oAuthWindowType,u=this.getOAuthUrl(i,a,s,e);if("newWindow"!==s&&("inAppBrowser"!=s||n&&n.is("cordova")&&(n.is("ios")||n.is("android")))){if("inAppBrowser"==s){var l=this.options.oAuthBrowserCallbacks[t];if(!l)throw new Error("To login with oAuth provider "+t+" using inAppBrowser the callback (in oAuthBrowserCallbacks) is required.");var p=o.create(u,"_blank","location=no");return new y.Observable(function(o){p.on("loadstop").subscribe(function(t){-1<t.url.indexOf(l)&&p.executeScript({code:"requestCredentials();"}).then(function(t){r.getAuthDataFromPostMessage(t[0]);var e=y.interval(400).subscribe(function(){r.userSignedIn()&&(o.next(r.authData),o.complete(),e.unsubscribe(),p.close())},function(t){o.error(t),o.complete()})},function(t){o.error(t),o.complete()})},function(t){o.error(t),o.complete()})})}if("sameWindow"===s)return this.global.location.href=u,undefined;throw new Error('Unsupported oAuthWindowType "'+s+'"')}var c=this.options.oAuthWindowOptions,h="";if(c)for(var d in c)c.hasOwnProperty(d)&&(h+=","+d+"="+c[d]);var g=window.open(u,"_blank","closebuttoncaption=Cancel"+h);return this.requestCredentialsViaPostMessage(g)},t.prototype.processOAuthCallback=function(){this.getAuthDataFromParams()},t.prototype.signOut=function(){var t=this;return this.http["delete"](this.getServerPath()+this.options.signOutPath).pipe(a.finalize(function(){t.localStorage.removeItem("accessToken"),t.localStorage.removeItem("client"),t.localStorage.removeItem("expiry"),t.localStorage.removeItem("tokenType"),t.localStorage.removeItem("uid"),t.authData.next(null),t.userType.next(null),t.userData.next(null)}))},t.prototype.validateToken=function(){var e=this,t=this.http.get(this.getServerPath()+this.options.validateTokenPath).pipe(a.share());return t.subscribe(function(t){return e.userData.next(t.data)},function(t){401===t.status&&e.options.signOutFailedValidate&&e.signOut()}),t},t.prototype.updatePassword=function(t){var e;null!=t.userType&&this.userType.next(this.getUserTypeByName(t.userType)),e=null==t.passwordCurrent?{password:t.password,password_confirmation:t.passwordConfirmation}:{current_password:t.passwordCurrent,password:t.password,password_confirmation:t.passwordConfirmation},t.resetPasswordToken&&(e.reset_password_token=t.resetPasswordToken);var o=e;return this.http.put(this.getServerPath()+this.options.updatePasswordPath,o)},t.prototype.resetPassword=function(t){var e;this.userType.next(null==t.userType?null:this.getUserTypeByName(t.userType));var o=((e={})[this.options.loginField]=t.login,e.redirect_url=this.options.resetPasswordCallback,e);return this.http.post(this.getServerPath()+this.options.resetPasswordPath,o)},t.prototype.getUserPath=function(){return null==this.userType.value?"":this.userType.value.path+"/"},t.prototype.getApiPath=function(){var t="";return null!=this.options.apiBase&&(t+=this.options.apiBase+"/"),null!=this.options.apiPath&&(t+=this.options.apiPath+"/"),t},t.prototype.getServerPath=function(){return this.getApiPath()+this.getUserPath()},t.prototype.getOAuthPath=function(t){var e;return null==(e=this.options.oAuthPaths[t])&&(e="/auth/"+t),e},t.prototype.getOAuthUrl=function(t,e,o,n){var r;return r=this.options.oAuthBase+"/"+t,r+="?omniauth_window_type="+o,r+="&auth_origin_url="+encodeURIComponent(e),n&&(r+="&registration_token="+n),null!=this.userType.value&&(r+="&resource_class="+this.userType.value.name),r},t.prototype.tryLoadAuthData=function(){var t=this.getUserTypeByName(this.localStorage.getItem("userType"));t&&this.userType.next(t),this.getAuthDataFromStorage(),this.activatedRoute&&this.getAuthDataFromParams()},t.prototype.getAuthHeadersFromResponse=function(t){var e=t.headers,o={accessToken:e.get("access-token"),client:e.get("client"),expiry:e.get("expiry"),tokenType:e.get("token-type"),uid:e.get("uid")};this.setAuthData(o)},t.prototype.getAuthDataFromPostMessage=function(t){var e={accessToken:t.auth_token,client:t.client_id,expiry:t.expiry,tokenType:"Bearer",uid:t.uid};this.setAuthData(e)},t.prototype.getAuthDataFromStorage=function(){var t={accessToken:this.localStorage.getItem("accessToken"),client:this.localStorage.getItem("client"),expiry:this.localStorage.getItem("expiry"),tokenType:this.localStorage.getItem("tokenType"),uid:this.localStorage.getItem("uid")};this.checkAuthData(t)&&this.authData.next(t)},t.prototype.getAuthDataFromParams=function(){var o=this;this.activatedRoute.queryParams.subscribe(function(t){var e={accessToken:t.token||t.auth_token,client:t.client_id,expiry:t.expiry,tokenType:"Bearer",uid:t.uid};o.checkAuthData(e)&&o.authData.next(e)})},t.prototype.setAuthData=function(t){this.checkAuthData(t)&&(this.authData.next(t),this.localStorage.setItem("accessToken",t.accessToken),this.localStorage.setItem("client",t.client),this.localStorage.setItem("expiry",t.expiry),this.localStorage.setItem("tokenType",t.tokenType),this.localStorage.setItem("uid",t.uid),null!=this.userType.value&&this.localStorage.setItem("userType",this.userType.value.name))},t.prototype.checkAuthData=function(t){return null!=t.accessToken&&null!=t.client&&null!=t.expiry&&null!=t.tokenType&&null!=t.uid&&(null==this.authData.value||t.expiry>=this.authData.value.expiry)},t.prototype.requestCredentialsViaPostMessage=function(t){var e=y.interval(500),o=y.fromEvent(this.global,"message").pipe(a.pluck("data"),a.filter(this.oAuthWindowResponseFilter));o.subscribe(this.getAuthDataFromPostMessage.bind(this));var n=e.subscribe(function(){t.closed?n.unsubscribe():t.postMessage("requestCredentials","*")});return o},t.prototype.oAuthWindowResponseFilter=function(t){if("deliverCredentials"===t.message||"authFailure"===t.message)return t},t.prototype.getUserTypeByName=function(e){return null==e||null==this.options.userTypes?null:this.options.userTypes.find(function(t){return t.name===e})},t.decorators=[{type:o.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:n.HttpClient},{type:undefined,decorators:[{type:o.Inject,args:[r]}]},{type:Object,decorators:[{type:o.Inject,args:[o.PLATFORM_ID]}]},{type:e.ActivatedRoute,decorators:[{type:o.Optional}]},{type:e.Router,decorators:[{type:o.Optional}]}]},t.ngInjectableDef=o.defineInjectable({factory:function(){return new t(o.inject(n.HttpClient),o.inject(r),o.inject(o.PLATFORM_ID),o.inject(e.ActivatedRoute,8),o.inject(e.Router,8))},token:t,providedIn:"root"}),t}(),u=function(){function t(t){this.tokenService=t}return t.prototype.intercept=function(t,e){var o=this;this.tokenService.getAuthDataFromStorage();var n=this.tokenService.authData.value;if(n&&(null===this.tokenService.tokenOptions.apiBase||t.url.match(this.tokenService.tokenOptions.apiBase))){var r={"access-token":n.accessToken,client:n.client,expiry:n.expiry,"token-type":n.tokenType,uid:n.uid};t=t.clone({setHeaders:r})}return e.handle(t).pipe(a.tap(function(t){return o.handleResponse(t)},function(t){return o.handleResponse(t)}))},t.prototype.handleResponse=function(t){(t instanceof n.HttpResponse||t instanceof n.HttpErrorResponse)&&(null===this.tokenService.tokenOptions.apiBase||t.url&&t.url.match(this.tokenService.tokenOptions.apiBase))&&this.tokenService.getAuthHeadersFromResponse(t)},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:i}]},t}(),l=function(){function e(t){if(t)throw new Error("AngularToken is already loaded. It should only be imported in your application's main module.")}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:n.HTTP_INTERCEPTORS,useClass:u,multi:!0},t.angularTokenOptionsProvider||{provide:r,useValue:t},i]}},e.decorators=[{type:o.NgModule}],e.ctorParameters=function(){return[{type:e,decorators:[{type:o.Optional},{type:o.SkipSelf}]}]},e}();t.ANGULAR_TOKEN_OPTIONS=r,t.AngularTokenService=i,t.AngularTokenModule=l,t.ɵb=u,t.ɵa=i,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=angular-token.umd.min.js.map